# 第3章 認証の設定

## アイデンティティープロバイダーの設定

このセクションを完了すると、HTPasswd アイデンティティープロバイダーを OpenShift 認証用に設定できるようになります。 


#### OpenShift のユーザーとグループの説明

認証と認可に関連する OpenShift リソースは数多く存在します。主なリソースタイプとその定義の一覧を以下に示します。

- ユーザー

OpenShift Container Platform アーキテクチャにおけるユーザーとは、API サーバーとやり取りするエンティティーです。
ユーザーリソースとは、システム内でのアクション実行者を表しています。ユーザーまたはユーザーが所属するグループにロールを直接追加することで、パーミッションを割り当てます。 

- アイデンティティー

ID とは、特定のユーザーおよびアイデンティティープロバイダーからの認証試行の成功を記録するリソースです。
認証のソースに関するあらゆるデータが、ID に格納されます。1 つのアイデンティティーリソースには 1 つのユーザーリソースしか関連付けられません。 

- サービスアカウント

OpenShift では、ユーザーの資格情報を取得できない場合、アプリケーションが独自に API と通信することができます。
一般ユーザーの資格情報の整合性を維持する目的で、資格情報を共有するのではなく、代わりにサービスアカウントが使用されます。サービスアカウントを使用すると、一般ユーザーの資格情報を借りずに API へのアクセスを制御することができます。 

- グループ

グループは、ある特定のユーザー群を表します。ユーザーは、1 つまたは複数のグループに割り当てられます。グループは、複数のユーザーに同時にパーミッションを割り当てる認可ポリシーを実装する際に、活用されます。たとえば、プロジェクト内のオブジェクトへのアクセスを 20 人のユーザーに許可したい場合、各ユーザーに個別にアクセス権を付与するのではなくグループを使用すると便利です。OpenShift Container Platform では、クラスターによって自動的にプロビジョニングされるシステムグループや仮想グループも提供されます。 

- ロール

ロールとは、1 つまたは複数のリソースタイプに関わる API 操作の実行をユーザーに許可するパーミッションのセットです。
ユーザー、グループ、およびサービスアカウントにロールを割り当てると、それらにパーミッションが付与されます。 


ユーザーリソースとアイデンティティーリソースは、通常、事前には作成されません。これらは通常、OAuth を使用した対話型ログインが成功した後、OpenShift によって自動的に作成されます。 


#### API リクエストの認証

認可と認証は、2 つのセキュリティー層であり、ユーザーとクラスターとのやり取りを可能にする役割を担います。
ユーザーが API にリクエストを行うと、そのユーザーはリクエストに関連付けられます。**認証層**は、ユーザーを識別する役割を担います。すると、**認可層**が、要求元ユーザーに関する認証層からの情報を使用して、その要求が受け入れられるかどうかを判断します。

OpenShift API では、リクエストを認証する手段として次の 2 つの方法があります。

- OAuth アクセストークン
- X.509 クライアント証明書 

リクエストがアクセストークンや証明書を提示しない場合、認証層はそれに対して system:anonymous 仮想ユーザーと system:unauthenticated 仮想グループを割り当てます。


#### 認証オペレーターの概要

OpenShift Container Platform には、OAuth サーバーを実行する認証オペレーターが用意されています。
OAuth サーバーは、ユーザーが API への認証を試みるときに、ユーザーに OAuth アクセストークンを提供します。アイデンティティープロバイダーを設定して OAuth サーバーで使用できるようにする必要があります。OAuth サーバーは、アイデンティティープロバイダーを使用して要求元の ID を検証します。サーバーは、ユーザーと ID を照合し、ユーザーに付与される OAuth アクセストークンを作成します。

アイデンティティーリソースとユーザーリソースは、ログイン時に自動的に作成されます。 

- アイデンティティープロバイダー
    - OpenShift OAuth サーバーで使用するよう設定できるアイデンティティープロバイダーは、多数存在しています。一般的なものを、次のリストに示します。

> HTPasswd

htpasswd を使用して生成された資格情報を保存するシークレットと照合して、ユーザー名とパスワードを検証します。 

> Keystone

OpenStack Keystone v3 サーバーを使用した共有認証を有効にします。 

> LDAP

シンプルなバインド認証を使用し、LDAPv3 サーバーと照合してユーザー名とパスワードを検証するよう LDAP アイデンティティープロバイダーを設定します。 

> GitHub または GitHub エンタープライズ

GitHub または GitHub エンタープライズの OAuth 認証サーバーと照合してユーザー名とパスワードを検証するよう GitHub アイデンティティープロバイダーを設定します。 

> OpenID コネクト

認可コードフローを使用して、OpenID コネクトアイデンティティープロバイダーと統合します。 

任意のアイデンティティープロバイダーで OAuth カスタムリソースを更新する必要があります。同じ OAuth カスタムリソース上に、同じ種類または異なる種類の複数アイデンティティープロバイダーを定義することができます。


## クラスター管理者としての認証

アイデンティティープロバイダーを設定してユーザーを管理するには、クラスター管理者として OpenShift クラスターにアクセスする必要があります。インストールされたばかりの OpenShift クラスターでは、クラスター管理者権限で API リクエストを認証するための手段として次の 2 つの方法があります。

- OAuth アクセストークンを付与する kubeadmin 仮想ユーザーおよびパスワード。
- 有効期限のない X.509 クライアント証明書を埋め込む kubeconfig ファイル。 

追加のユーザーを作成し、異なるアクセスレベルをそれらに付与するには、アイデンティティープロバイダーを設定して、ユーザーにロールを割り当てる必要があります。 


#### X.590 証明書を使用した認証 

kubeconfig ファイルはインストールプロセス中に作成されます。
これはクラスターに固有のものとなります。このファイルは、インストール中に OpenShift インストーラーによって作成された auth ディレクトリに保存されます。ファイルには、CLI がクライアントを適切な API サーバーに接続するために使用する、特定の詳細情報とパラメーター (X.509 証明書など) が含まれます。 

kubeconfig ファイルを使用して oc コマンドを認証するには、ファイルをワークステーションにコピーし、絶対パスまたは相対パスを KUBECONFIG 環境変数に設定する必要があります。そうしておくと、**OpenShift にログインしなくても、クラスター管理者権限を必要とするあらゆる oc を実行できるようになります。**

> export KUBECONFIG=/home/user/auth/kubeconfig


#### 仮想ユーザーを使用した認証

**インストールが完了すると、OpenShift は kubeadmin 仮想ユーザーを作成します。**
その仮想ユーザーにはユーザーリソースやアイデンティティーリソースはありません。kubeadmin ユーザーはクラスター管理者としてハードコーディングされており、その権限を変更することはできません。また、kube-system プロジェクトから、kubeadmin に保存されているパスワードを使用して認証を行うためのハードコーディングもされています。
kubeadmin パスワードは、インストーラーによって動的に生成され、各環境に対して完全に一意のものとなります。


#### 仮想ユーザーの削除 

アイデンティティープロバイダーを定義し、新しいユーザーを作成し、そのユーザーに cluster-admin ロールを割り当てた後、kubeadmin ユーザーの資格情報を削除してクラスターのセキュリティーを向上させることができます。

> oc delete secret kubeadmin -n kube-system


#### HTPasswd アイデンティティープロバイダーの設定 

HTPasswd アイデンティティープロバイダーは、Apache HTTP サーバープロジェクト由来の htpasswd コマンドで生成されたユーザー名とパスワードを含むシークレットと照合して、ユーザーを検証します。
シークレット内データの変更を許されるのはクラスター管理者のみです。一般ユーザーが自分のパスワードを変更することはできません。 

- HTPasswd アイデンティティープロバイダーを使用したユーザー管理

HTPasswd アイデンティティープロバイダーを使用してユーザー資格情報を管理するには、一時的な htpasswd ファイルを作成し、ファイルに変更を加え、これらの変更をシークレットに適用する必要があります。 

> 
HTPasswdの一時ファイル作成

> 
HTPasswdファイルの更新


#### 管理者権限の割り当て

クラスター全体の cluster-admin ロールを使用することで、ユーザーとグループに対してクラスター管理者権限が付与されます。これにより、ユーザーは、クラスター内の任意のリソースに対して任意のアクションを実行できるようになります。

次の例では、student ユーザーに cluster-admin ロールが割り当てられています。

> oc adm policy add-cluster-role-to-user cluster-admin student