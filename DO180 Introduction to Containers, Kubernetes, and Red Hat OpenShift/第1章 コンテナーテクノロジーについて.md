# 第1章 コンテナーテクノロジーについて


## コンテナーテクノロジーの概要

#### コンテナー化されたアプリケーション

ソフトウェアアプリケーションは通常、ランタイム環境によって提供される他のライブラリ、設定ファイル、またはサービスに依存します。 ソフトウェアアプリケーションの従来のランタイム環境は物理ホストまたは仮想マシンであり、アプリケーションの依存関係はホストの一部としてインストールされます。 

従来の方法でデプロイされているソフトウェアアプリケーションの主な欠点は、アプリケーションの依存関係がランタイム環境と絡み合ってしまうことです。 更新プログラムまたはパッチが基本オペレーティングシステム (OS) に適用されると、アプリケーションが破損することがあります。 

**コンテナー** は、システムの他の部分から独立した 1 つ以上のプロセスのセットです。 

コンテナーには、セキュリティー、ストレージ、ネットワークの分離など、仮想マシンと同じ多くの利点があります。コンテナーが必要とするハードウェアリソースははるかに少なく、起動と終了が迅速です。

また、アプリケーションのライブラリとランタイムリソース (CPU やストレージ) を分離し、OS の更新がホスト OS に与える影響を最小限に抑えます。

Rocket、Drawbridge、LXC、Docker、Podman など、各コンテナーを管理し、実行するために利用できるコンテナーエンジンは多数あります。

- コンテナーの利点

1. ハードウェアのフットプリント(稼働時に占有・消費する資源の多さ)が小さい

コンテナーは分離された環境の作成に OS の内部機能を使用し、環境のリソースは **namespace や cgroups などの OS 機能を使って管理されます。**
この方法では、仮想マシンのハイパーバイザーと比べて、CPU 量やメモリーオーバーヘッドを最小限に抑えられます。VM でアプリケーションを実行すると実行中の環境からは分離できますが、コンテナーが実行する、同じようにハードウェア占有スペースの少ない分離に対応するために、多くのサービス層が必要になります。

2. 環境の分離 

コンテナーがホスト OS や他のアプリケーションの変更の影響を受けない、**閉じた環境** で稼働できます。コンテナーが必要とするライブラリは内蔵型であるため、アプリケーションは中断のない実行が可能です。たとえば、各アプリケーションは、専用のコンテナー内に固有の一連のライブラリとともに存在できます。1 つのコンテナーに実施された更新は、他のコンテナーに影響を与えません。 

3. 迅速なデプロイ

基本となるOS全体をインストールする必要がないため、コンテナーは迅速にデプロイできます。

通常は、分離に対応するには、物理ホストまたは VM に新たに OS をインストールする必要があり、更新のみの場合は OS の完全な再起動が必要になります。
コンテナーを再起動する場合、ホスト OS のサービスを停止させる必要はありません。 

4. 複数の環境のデプロイ 

単一のホストを使用する従来のデプロイシナリオでは、環境の違いによりアプリケーションが破損することがありました。

しかし、コンテナーを使用すると、**アプリケーションの依存関係と環境設定はすべてコンテナーイメージにカプセル化** されます。 

5. 再利用性

OS をすべてセットアップすることなく、同じコンテナーを再利用できます。


## コンテナーアーキテクチャの概要

#### コンテナーの歴史について

- **namespace**

カーネルは通常、すべてのプロセスに表示される特定のシステムリソースを namespace 内に配置することで、分離できます。

namespace 内では、そこに含まれるプロセスのみがこれらのリソースを参照できます。namespace には、ネットワークインターフェース、プロセス ID リスト、マウントポイント、IPC リソース、システム自身のホスト名情報などのリソースを配置できます。 

- **制御グループ (cgroups)**

制御グループは、プロセスと子プロセスのセットをパーティションでグループごとに区切り、それらが使用するリソースを管理および制限します。
制御グループは、プロセスが使用できるシステムリソースの量に制限を設けます。これらの制限により、1 つのプロセスがホスト上で過剰なリソースを使用することを防ぎます。 

- Seccomp

2005 年に開発され、2014 年頃にコンテナーに導入された Seccomp は、プロセスがシステムコールを使用する方法を制限します。Seccomp はプロセスのセキュリティープロファイルを定義し、それらが使用を許可されているシステムコール、パラメーター、およびファイル記述子をホワイトリストに登録します。 

- SELinux

SELinux (Security-Enhanced Linux) はプロセスに欠かせないアクセス制御システムです。Linux カーネルは SELinux を使用して、プロセスを相互に保護し、実行中のプロセスからホストシステムを保護します。プロセスは、ホストシステムリソースへの限定的なアクセスが可能な、制限された SELinux タイプとして実行されます。 


#### Linux コンテナーアーキテクチャの説明

Linux カーネルから見ると、コンテナーは制限付きのプロセスです。

コンテナーはイメージを実行します。**イメージは、ファイルシステム内のファイル、インストールされているパッケージ、利用可能なリソース、実行中のプロセス、カーネルモジュールなど、プロセスの実行に必要な依存関係をすべて含むファイルシステムバンドル** です。 


## Kubernetes と OpenShift の概要

#### コンテナーの制限

コンテナーを使用すると、サービスを簡単にパッケージ化し、実行できます。組織が管理するコンテナーの数が増えるにつれて、それらを手動で起動する作業が急激に増加し、外部の要求に迅速に対応する必要性も増大します。 

本番環境でコンテナーを使用するときに、企業では多くの場合以下のことが必要になります。

- 多数のサービス間の容易なコミュニケーション
- アプリケーションを実行しているコンテナーの数にかかわらず、アプリケーションのリソースを制限する
- アプリケーション使用量の急増に対応し、実行中のコンテナーを増減させる
- サービス低下に対応する
- 一連のユーザーに新しいリリースを徐々にロールアウトする 

コンテナーランタイム (Podman など) は上記の要件に十分に対処していない(膨大な量のため)ため、企業は**コンテナーオーケストレーションテクノロジー** を必要とします。 


#### Kubernetes の概要

**Kubernetes は、コンテナー化されたアプリケーションのデプロイメント、管理、およびスケーリングを簡潔化するオーケストレーションサービス** です。

Kubernetes の最小管理単位は Pod です。Pod は、ストレージリソースと IP アドレスを備えた、単一のアプリケーションを表す 1 つ以上のコンテナーで構成されてます。Kubernetes は、Pod を使用してその中のコンテナーのオーケストレーションを実行し、そのリソースを 1 つの単位として制限します。 


#### Kubernetes の機能

1. サービスの検出と負荷分散

Kubernetes により、単一の DNS(Domain name System) エントリーをコンテナーの各セットに割り当てることで、サービス間のコミュニケーションが有効になります。このように、要求側サービスはターゲットの DNS 名を知るだけでよく、クラスターはコンテナーの位置と IP アドレスを変更でき、サービスは影響を受けません。これにより、サービスを提供するコンテナーのプールで要求の負荷分散が許可されます。たとえば、Kubernetes は Pod の可用性を考慮して MySQL サービスへの受信要求を均等に分割できます。 

2. 水平スケーリング

アプリケーションは、Kubernetes コマンドラインインターフェースまたは web UI のいずれかで設定された設定を使用して、手動または自動で拡大または縮小できます。 

3. 自己回復

Kubernetes はユーザー定義のヘルスチェックを使用して、コンテナーを監視し、障害が発生した場合にコンテナーを再起動および再スケジュールできます。

4. 自動ロールアウト

Kubernetes は、ステータスを確認しながら、アプリケーションのコンテナーに更新を徐々にロールアウトすることができます。ロールアウト中に問題が発生した場合、Kubernetes は前回のデプロイメントにロールバックすることができます。 

5. 秘密と構成管理

コンテナーを再構築することなく、構成設定とアプリケーションの機密を管理できます。アプリケーションの機密情報には、ユーザー名、パスワード、サービスエンドポイントなど、非公開にする必要がある構成設定が含まれます。 

- Operator

Operator は、アプリケーションのライフサイクルのナレッジを Kubernetes クラスターにもたらすパッケージ化された Kubernetes アプリケーションです。Operator としてパッケージ化されたアプリケーションは、Kubernetes API を使用して、アプリケーションの状態の変化に応じてクラスターの状態を更新します。 

#### OpenShift の概要

Red Hat OpenShift Container Platform (RHOCP) = **Openshift** は、Kubernetes コンテナーインフラストラクチャ上に構築された、モジュール式のコンポーネントとサービスのセットです。RHOCP は遠隔管理、マルチテナント機能、高度なセキュリティー、監視と監査、アプリケーションライフサイクル管理、開発者向けのセルフサービスインターフェースなどの本番 PaaS プラットフォームを提供する機能も備えています。 

- OpenshiftはKubernetesに以下の**機能を追加する**

1. 統合的な開発者ワークフロー

RHOCP は、ビルトインコンテナーレジストリー、CI/CD パイプライン、S2I を統合した、ソースリポジトリからコンテナーイメージまでのアーティファクトを構築するためのツールです。 

2. ルート

サービスを外の世界に簡単に公開します。 

3. メトリクスとロギング

ビルトインおよび自己分析メトリクスサービスと集約ロギングが含まれます。 

4. 統合 UI

OpenShift は、さまざまな機能を管理する統合されたツールと UI を提供します。 


